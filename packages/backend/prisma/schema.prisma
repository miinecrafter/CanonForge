datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           Int             @id @default(autoincrement())
  username     String          @unique
  email        String          @unique
  passwordHash String
  role         Role            @default(READER)
  createdAt    DateTime        @default(now())

  // Pivot table relation
  projectOwners ProjectOwners[]

  // Other relations
  contributions Submission[]   @relation("AuthorSubmissions")
  reviews      Review[]
  addedCanon   CanonEntry[]    @relation("UserAddedCanon")
}

model Project {
  id           Int              @id @default(autoincrement())
  title        String
  slug         String           @unique
  description  String?
  visibility   Visibility       @default(PUBLIC)
  createdAt    DateTime         @default(now())

  // Pivot table relation
  owners       ProjectOwners[]

  submissions  Submission[]
  canonEntries CanonEntry[]
  tags         Json?
}

model ProjectOwners {
  id        Int       @id @default(autoincrement())
  project   Project   @relation(fields: [projectId], references: [id])
  projectId Int
  user      User      @relation(fields: [userId], references: [id])
  userId    Int
  role      OwnerRole @default(OWNER)
  createdAt DateTime  @default(now())
}

model Submission {
  id           Int              @id @default(autoincrement())
  project      Project          @relation(fields: [projectId], references: [id])
  projectId    Int
  author       User             @relation("AuthorSubmissions", fields: [authorId], references: [id])
  authorId     Int
  title        String
  content      String
  contentDelta Json?
  status       SubmissionStatus @default(DRAFT)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  reviews      Review[]
  attachments  Attachment[]
  canonical    CanonEntry?
}

model Review {
  id           Int        @id @default(autoincrement())
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId Int
  reviewer     User       @relation(fields: [reviewerId], references: [id])
  reviewerId   Int
  feedback     String?
  decision     Decision?
  createdAt    DateTime   @default(now())
}

model CanonEntry {
  id           Int        @id @default(autoincrement())
  project      Project   @relation(fields: [projectId], references: [id])
  projectId    Int
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId Int       @unique
  addedBy      User       @relation("UserAddedCanon", fields: [addedById], references: [id])
  addedById    Int
  addedAt      DateTime  @default(now())
  notes        String?
}

model Attachment {
  id           Int      @id @default(autoincrement())
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId Int
  key          String
  url          String
  mime         String
  createdAt    DateTime @default(now())
}

enum Role {
  READER
  WRITER
  MODERATOR
  ADMIN
}

enum OwnerRole {
  OWNER
  COLLABORATOR
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DECLINED
}

enum Decision {
  APPROVED
  DECLINED
  CHANGES_REQUESTED
}
